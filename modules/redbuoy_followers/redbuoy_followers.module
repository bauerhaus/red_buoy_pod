<?php

use Drupal\Core\Url;
use Drupal\Component\Utility\Html;
use Drupal\node\Entity\Node;

/**
 * Implements hook_preprocess_page().
 *
 * Adds a "Leave a comment" CTA above the comments view when arriving with
 * ?from_node=<nid>&feed=<feed>.
 */
function redbuoy_followers_preprocess_page(array &$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();

  // Adjust if your view route/display differs.
  // Typical is: view.<view_id>.<display_id>
  if ($route_name !== 'view.follower_comments.page_1') {
    return;
  }

  $request = \Drupal::request();
  $feed = (string) $request->query->get('field_podcast_feed_value');
  $from_nid = (int) $request->query->get('from_node');

  // If no context, still show a gentle CTA to pick an episode (later),
  // but for now we only show the contextual CTA when we have a valid episode.
  if ($from_nid <= 0 || $feed === '') {
    return;
  }

  /** @var \Drupal\node\NodeInterface|null $episode */
  $episode = Node::load($from_nid);
  if (!$episode || $episode->bundle() !== 'podcast_episode' || !$episode->isPublished()) {
    return;
  }

  // Confirm the feed matches the episode’s canonical feed.
  if (!$episode->hasField('field_podcast_feed') || $episode->get('field_podcast_feed')->isEmpty()) {
    return;
  }
  $episode_feed = (string) $episode->get('field_podcast_feed')->value;
  if ($episode_feed !== $feed) {
    return;
  }

  // Feed label helper you added earlier.
  $feed_label = function_exists('redbuoy_media_pod_feed_label')
    ? redbuoy_media_pod_feed_label($feed)
    : $feed;

  $comment_url = Url::fromRoute('redbuoy_followers.new', [], [
    'absolute' => TRUE,
    'query' => [
      'feed' => $feed,
      'node' => $from_nid,
    ],
  ])->toString();

  $episode_title = Html::escape($episode->label());

  $cta = [
    '#type' => 'container',
    '#attributes' => ['class' => ['rb-followers-cta']],
    'markup' => [
      '#markup' =>
      '<div class="rb-followers-cta__inner">' .
        '<p><strong>Community comments — ' . Html::escape($feed_label) . '</strong><br>' .
        'You arrived here from: “' . $episode_title . '”.</p>' .
        '<p><a class="button button--primary" href="' . Html::escape($comment_url) . '">Leave a comment on this episode</a></p>' .
        '<p><em>Your comment will appear after moderation.</em></p>' .
        '</div>',
    ],
    '#weight' => -10,
  ];

  // Put it above the main content.
  $variables['page']['content']['rb_followers_cta'] = $cta;
}
